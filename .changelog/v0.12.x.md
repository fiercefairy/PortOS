# Release v0.12.x - Changelog

Released: YYYY-MM-DD

## Overview

This release adds branch management and automated release workflow capabilities to the DevTools Git page.

## Features

### DevTools Git — Branch Update, Comparison & Release PR Workflow
- **Update Branches button**: One-click fetch and fast-forward merge of `dev` and `main` from origin, with automatic stash/restore if the working tree is dirty
- **Branch Comparison panel**: Shows how many commits `dev` is ahead of `main`, with commit list, diff stats (+insertions/-deletions/files changed), displayed as a "Release Status" card
- **Automated Release PR**: "Create Release PR" button triggers a full CoS agent task that pushes commits, updates the changelog, creates a PR from dev to main, iterates with Copilot review feedback (up to 3 rounds), verifies CI, and merges when approved
- **Release Confirmation dialog**: Modal listing the exact steps the agent will perform, preventing accidental releases
- **Push endpoint**: New server endpoint for pushing branches to origin, used by the release workflow

**Server changes**:
- `server/services/git.js` — Added `fetchOrigin`, `updateBranches`, `getBranchComparison`, `push` functions
- `server/routes/git.js` — Added `/update-branches`, `/branch-comparison`, `/push` POST endpoints

**Client changes**:
- `client/src/services/api.js` — Added `updateBranches`, `getBranchComparison`, `pushBranch` API functions
- `client/src/pages/DevTools.jsx` — Expanded GitPage with Update button, Release Status panel, release confirmation dialog, and CoS task integration

### CoS — Productivity & Streaks Dashboard
- **New Productivity Tab**: Added a "Streaks" tab to the Chief of Staff page that tracks work patterns and productivity metrics
- **Work Streaks**: Tracks consecutive days and weeks with completed tasks, displaying current and best streaks with visual emphasis
- **Hourly & Daily Patterns**: Analyzes which hours and days of the week have the highest success rates for tasks
- **AI Insights**: Generates recommendations like "Peak Performance Hour" and "Most Productive Day" based on historical patterns
- **Milestones**: Tracks achievements like "Completed 100 tasks" or "7-day work streak"
- **Gamification**: Flame icon for active streaks, trophy icons for milestones, encouraging consistent productivity

**Server changes**:
- `server/services/productivity.js` — New service with streak calculation, pattern analysis, and milestone tracking
- `server/routes/cos.js` — Added `/productivity`, `/productivity/summary`, `/productivity/recalculate` endpoints

**Client changes**:
- `client/src/components/cos/tabs/ProductivityTab.jsx` — Full-featured productivity dashboard with collapsible sections
- `client/src/components/cos/constants.js` — Added "Streaks" tab with Flame icon
- `client/src/services/api.js` — Added `getCosProductivity`, `getCosProductivitySummary`, `recalculateCosProductivity` functions

### Media → Security Page Rename
- **Renamed** the "Media" page to "Security" to better reflect its purpose as a remote security camera and microphone
- Updated route from `/media` to `/security`
- Added descriptive subtitle explaining the page turns the PortOS host into a remote webcam and audio monitor accessible over Tailscale from a phone

### DevTools Git — Generic Git Management for All Managed Apps
- **Auto-detect branches**: Server now detects `main`/`master` and `dev`/`develop` branches per-repo instead of hardcoding `dev`/`main`
- **Changelog detection**: `getGitInfo()` returns whether a `.changelog/` directory exists, enabling conditional changelog steps in release prompts
- **Generalized Update**: `updateBranches()` auto-detects which branches to update instead of hardcoded `['dev', 'main']`
- **Generalized Release PR**: `buildReleasePrompt()` now uses the app name, detected branch names, and conditionally includes changelog management based on repo structure
- **App filtering**: Archived apps are filtered out of the Git page dropdown
- **Dynamic UI**: Branch comparison label, release button visibility, release dialog steps, and toast messages all adapt to detected branch names

### CoS — Completed Agent Timestamps
- **Completed timestamp display**: Completed agent cards now show the date and time they finished (e.g., "Feb 8 3:30 PM") next to the duration, with full timestamp on hover

## Fixes

### Managed App Port Conflict — ENV Leak & Detection
- **Fix**: When PortOS started managed apps via `startFromEcosystem()`, the PortOS server's own `PORT=5554` env var leaked into child processes. Apps with `process.env.PORT || fallback` in their ecosystem configs would bind to 5554 instead of their intended port, crashing portos-server on restart.
- **Fix**: Port detection regex in `parseEcosystemConfig()` couldn't parse `process.env.PORT || 4420` expressions — it only captured `process.env.PORT` and failed to resolve it. Now extracts the `|| fallback` value.
- **Solution**: `startFromEcosystem()` now strips `PORT` and `HOST` from the inherited env before spawning PM2, and `resolvePortValue()` handles `expr || fallback` patterns

### Runner Config Access Crash
- **Fix**: `server/services/runner.js` was accessing `aiToolkitInstance.config.dataDir` and `aiToolkitInstance.config.hooks`, but the AI Toolkit object returned by `createAIToolkit()` has no `.config` property (config is internal to service closures). This caused a `TypeError: Cannot read properties of undefined (reading 'dataDir')` whenever the PortOS runner shim's `executeCliRun` was invoked.
- **Solution**: Pass `dataDir` and `hooks` explicitly to the runner shim via `setAIToolkit(toolkit, config)` and store them in a local `runnerConfig` variable
