# Release v0.11.x - Changelog

Released: YYYY-MM-DD

## Overview

This release focuses on security improvements, bug fixes for the AI runner system, and enhanced AI provider model management.

## üéâ Features

### Universal Model Refresh for AI Providers
- **Model Refresh Button**: Added "Refresh Models" button to AI providers on the `/devtools/providers` page
- **Multi-Provider Support**: Refresh now works for both API and CLI providers including:
  - API providers: OpenAI, LM Studio, Ollama (with provider-specific endpoint detection)
  - CLI providers: Claude/Anthropic (returns latest model list)
- **Smart UI**: Button is hidden for providers that don't require model specification (e.g., Gemini CLI)
- **User Feedback**: Toast notifications show success/failure messages with descriptive error handling
- **Loading States**: Button shows "Refreshing..." state during model fetch operations
- **Graceful Degradation**: Providers without refresh support show appropriate error messages

**Implementation Details**:
- Updated `portos-ai-toolkit` to support provider-specific refresh strategies
- Added `_refreshAPIProviderModels()` for API-based providers with multi-format support
- Added `_refreshCLIProviderModels()` with provider detection and API integration
- Client shows refresh button for all providers (previously API-only)
- Enhanced error handling with user-friendly toast notifications

**Files Modified**:
- `portos-ai-toolkit/src/server/providers.js` - Universal refresh implementation
- `client/src/pages/AIProviders.jsx` - UI updates with toast notifications

### Digital Twin Interview & Enrichment Guide
- Redesigned "Interview" tab as a single-page assessment analyzer + enrichment guide
- Paste AI personality assessments for automated analysis and twin profile updates
- Enrichment gap dashboard shows which areas need the most attention
- Direct navigation from gaps to specific enrichment categories
- Automatically maps traits to Big Five, values, and communication dimensions
- Creates new documents for personality dimensions not yet captured
- Removed session-based chat interface in favor of simpler paste-and-analyze flow

### Digital Twin Enrichment UX Improvements
- **Deep-link Enrich buttons**: All "Enrich" buttons on gap cards and completeness missing sections now navigate directly to the specific enrichment category (e.g., `/digital-twin/enrich?category=values`) instead of the generic landing page
- **"Start Enrichment Session" targets top gap**: The main CTA button uses the most critical gap's category for immediate action
- **"Enrich Soul" quick action uses top gap**: The overview quick action card navigates to the highest-priority gap's category when available
- **Next Action Banner on Overview**: New contextual banner at the top of the overview tab with three modes:
  - **No profile yet**: Suggests pasting a personality assessment via the Interview tab
  - **Gaps exist (Q&A)**: Shows an inline question from the top gap's category with submit/skip, Ctrl+Enter shortcut, and link to full enrichment
  - **Gaps exist (list-based)**: Shows a navigate prompt for list categories (books, movies, music)
  - **All caught up**: Confirms the twin is well-defined and links to behavioral tests

### Likert-Scale Trait Scoring for Digital Twin Enrichment
- **Immediate Trait Feedback**: Enrichment now includes 1-5 Likert-scale questions that directly update trait scores and confidence when answered, closing the loop between enrichment answers and personality modeling
- **18 Scale Questions**: Covers Big Five (10 items), communication style (2), daily routines (2), values (2), and decision heuristics (2) ‚Äî each mapped to a specific trait dimension
- **Weighted Moving Average**: Scale answers blend with existing scores using a 0.3 weight factor, preventing any single answer from dominating while still moving the needle
- **Confidence Boost**: Each scale answer adds +0.15 to the relevant dimension's confidence score, so 3-4 answers can cross the 0.6 gap threshold and remove that dimension from recommendations
- **Inline Scale UI**: New `ScaleInput` component renders 5 touch-friendly buttons with labels, working in both the full EnrichTab and the NextActionBanner's quick-enrich mode
- **Backward Compatible**: `questionType` defaults to `text`, existing text question flow is completely unchanged, old client submissions still work

## üêõ Bug Fixes

### CLI Runner Security & Reliability
- **Security Warning Fix**: Resolved Node.js DEP0190 deprecation warning in CLI runner by removing unsafe `shell: true` option from child process spawning
- **Improved Argument Handling**: CLI commands now use direct argument passing instead of shell interpretation, preventing potential security vulnerabilities from unescaped arguments
- **Enhanced Logging**: Added detailed logging for CLI execution showing full command and prompt preview to aid debugging
- **Context**: The `/devtools/runner` page was generating security warnings when executing Claude CLI commands. The fix removes shell interpretation which was unnecessary and insecure, while maintaining full functionality

**Technical Details**:
- Created override in `server/services/runner.js` for `executeCliRun()` function
- Removed `shell: true` option from `spawn()` call (recommended by Node.js security guidelines)
- Arguments are now properly passed as array without shell metacharacter interpretation
- Added runtime patching in `server/index.js` to inject fixed implementation into AI toolkit

**Files Modified**:
- `server/services/runner.js` - New secure CLI execution implementation
- `server/index.js` - Runtime patching to override toolkit's runner

### Brain Inbox Classification Hang on Capture
- **Background Classification**: Brain inbox thought capture now returns immediately instead of blocking the UI while waiting for AI classification
- **Real-time Updates**: Classification results are pushed to the client via Socket.IO events (`brain:classified`), with toast notifications showing the result
- **New "Classifying" Status**: Added `classifying` status with animated UI indicator so users can see thoughts being processed in real time
- **No More Hangs**: Previously, submitting a thought would hang the UI spinner indefinitely if the AI provider was slow or unresponsive. Now the thought is saved instantly and classified in the background

**Files Modified**:
- `server/services/brain.js` - Split `captureThought` into immediate return + background `classifyInBackground`
- `server/services/socket.js` - Added brain event forwarding via `setupBrainEventForwarding`
- `server/lib/brainValidation.js` - Added `classifying` to inbox status enum
- `server/services/brainStorage.js` - Added `classifying` to inbox log counts
- `client/src/components/brain/tabs/InboxTab.jsx` - Socket.IO listener for classification results, classifying section UI
- `client/src/components/brain/constants.js` - Added `classifying` status color

### Killed Tasks No Longer Requeue
- **DevTools Kill Integration**: Killing a CoS agent via the DevTools process manager (`DELETE /api/agents/:pid`) now delegates to the CoS `killAgent()` function, which properly blocks the task instead of letting the close handler treat it as a retryable failure
- **Immediate Task Blocking**: Both `terminateAgent()` and `killAgent()` in direct mode now immediately update the task to `blocked` with `user-terminated` category, matching the runner mode behavior. Previously, task blocking was deferred to the close handler, creating a window where server restarts could cause requeue
- **Orphan Handler Guard**: `handleOrphanedTask()` now skips tasks already marked as `user-terminated`, preventing any residual requeue path

### Task Enhancement Empty Result No Longer Throws Error
- **Graceful fallback**: When an AI provider returns an empty response during task prompt enhancement, the server now returns the original description instead of throwing a 500 error
- **Reduced log noise**: Empty enhancement results log a warning instead of surfacing as route errors
- **Client unchanged**: The client already handled enhancement failures gracefully; this fix prevents unnecessary error noise server-side

### AI Providers Status Unreachable on Health Page
- **Route shadowing fix**: The `/api/providers/status` endpoint was being intercepted by the AI toolkit's `GET /:id` route (treating "status" as a provider ID), returning "Provider not found" instead of the actual status data
- **Root cause**: PortOS mounted the toolkit's parameterized routes before its own `/status` route, so Express matched the toolkit's `/:id` first
- **Fix**: Reordered route registration so PortOS-specific routes (including `/status`) are defined before mounting the toolkit's catch-all routes

### Quick Enrich Repeats Already-Answered Questions
- **AI fallback no longer recycles answered questions**: When all predefined and scale questions for a category are exhausted and AI question generation fails, the system now serves a generic follow-up ("What else should your digital twin know about your [category]?") instead of repeating the first predefined question
- **Deduplicated near-identical questions**: `values` and `non_negotiables` categories previously had nearly identical first questions; `values` now asks a distinct question about top three guiding values

### Quick Enrich Skip Returns Same Question
- **Skip now advances to a different question**: Clicking "Skip" on Quick Enrich prompts (both in the overview banner and the full EnrichTab) previously returned the exact same question, because question selection was deterministic based on `questionsAnswered` count which skip didn't increment
- **Client tracks skipped indices**: Both NextActionBanner and EnrichTab now maintain a `skippedIndices` list for the current session, passing it to the server so it can serve the next non-skipped question
- **Works for all question types**: Predefined questions skip by index, scale questions skip by negative-offset convention, and AI-generated questions already vary via temperature

### Digital Twin Personality Trait Confidence Display & Recalculation
- **Low confidence bars now grey instead of red**: Personality trait bars with low confidence (<60%) now display as grey rather than red, avoiding the false impression of errors when data is simply unverified or sparse
- **Confidence recalculates after trait analysis**: Running "Analyze Traits" or processing an AI interview assessment now automatically recalculates confidence scores, so the displayed confidence reflects the latest data instead of remaining stale from a previous manual calculation

### Autofixer App Replaced with PortOS Default
- Replaced the standalone Autofixer app with PortOS default app in sample data to avoid confusion

### Immediate Task Execution for User Tasks
- **Instant Spawn**: User-submitted tasks now start immediately when agent slots are available, instead of waiting up to 60 seconds for the next evaluation interval
- **Slot-Free Dequeue**: When an agent completes and frees a slot, the next pending task is immediately dequeued and spawned without waiting for the evaluation cycle
- **Priority Preserved**: Dequeue on slot free checks user tasks first, then auto-approved system tasks, maintaining the existing priority order
- **Evaluation Interval Preserved**: The periodic evaluation interval continues to handle system task generation, idle reviews, and mission tasks ‚Äî immediate execution is specifically for dequeuing pending work

### Autonomous Jobs (M37)
- **Recurring Proactive Jobs**: The CoS can now run scheduled recurring jobs on your behalf ‚Äî maintaining repositories, processing brain ideas, generating daily briefings, and reviewing projects
- **Digital Twin Integration**: Jobs execute using your digital twin identity, so the CoS acts with your preferences and values in mind
- **4 Built-in Jobs**: Ships with Git Repo Maintenance (weekly), Brain Inbox Processing (daily), Daily Briefing (daily), and Brain Project Review (weekly) ‚Äî all disabled by default for opt-in
- **Jobs Tab UI**: New "Jobs" tab on the `/cos/jobs` page with toggle controls, interval configuration, manual trigger, inline editing, and prompt template visibility
- **Custom Jobs**: Create your own recurring jobs with custom prompt templates, intervals (hourly to monthly), priority levels, and autonomy levels (standby/assistant/manager/yolo)
- **Evaluation Integration**: Due jobs are checked during each CoS evaluation cycle at Priority 3.5 (between missions and idle review), only when no user tasks are pending
- **Full CRUD API**: REST endpoints at `/api/cos/jobs` for listing, creating, updating, toggling, triggering, and deleting jobs

**Files Added**:
- `server/services/autonomousJobs.js` ‚Äî Job management service with scheduling, execution tracking, and task generation
- `client/src/components/cos/tabs/JobsTab.jsx` ‚Äî Jobs tab UI component

**Files Modified**:
- `server/services/cos.js` ‚Äî Added autonomous jobs to evaluation loop (Priority 3.5), added `autonomousJobsEnabled` config
- `server/routes/cos.js` ‚Äî Added `/api/cos/jobs` REST endpoints
- `client/src/services/api.js` ‚Äî Added autonomous jobs API functions
- `client/src/components/cos/constants.js` ‚Äî Added Jobs tab to navigation
- `client/src/components/cos/index.js` ‚Äî Export JobsTab component
- `client/src/pages/ChiefOfStaff.jsx` ‚Äî Render Jobs tab

### Completed Agents Search
- **Search bar**: Added a search input to the Completed Agents section on the Agents tab, allowing quick filtering by task description, model, agent ID, or error message
- **Full results when searching**: When a search query is active, all matching agents are shown (bypasses the default 15-item limit) so you can find any completed agent
- **Match count**: Displays "X of Y agents match" when filtering is active

**Files Modified**:
- `client/src/components/cos/tabs/AgentsTab.jsx` ‚Äî Added search state, filtered list with `useMemo`, search input UI

### Quick Task Templates
- **One-click task creation**: Added a collapsible "Quick Templates" section above the task form with 8 built-in templates for common task patterns (fix mobile, add feature, fix bug, refactor, add tests, improve UX, add API, security fix)
- **Save as template**: New "Save Template" button lets you save the current form as a reusable template for future tasks
- **Usage tracking**: Templates show usage counts and are sorted by popularity so your most-used templates appear first
- **Custom templates**: Create and delete your own templates; built-in templates cannot be deleted
- **Template presets**: Each template populates description, context, and optionally provider/model/app settings

**Files Added**:
- `server/services/taskTemplates.js` ‚Äî Template management with built-in templates, usage tracking, CRUD operations

**Files Modified**:
- `server/routes/cos.js` ‚Äî Added `/api/cos/templates` REST endpoints
- `client/src/services/api.js` ‚Äî Added template API functions
- `client/src/components/cos/tabs/TasksTab.jsx` ‚Äî Template UI with apply/save/delete functionality

## üîß Improvements

### Live Output Streaming for Claude CLI Agents
- **Real-time Feedback**: Claude CLI agents now stream output in real-time as they work, matching the live output experience previously only available with Codex
- **Stream-JSON Parsing**: Uses Claude CLI's `--output-format stream-json --verbose --include-partial-messages` flags to receive incremental text deltas as they're generated
- **Tool Use Visibility**: Shows tool invocations (e.g., "üîß Using Edit...") in the live output so users can see what the agent is doing
- **Both Spawn Modes**: Works in both direct spawn mode and via the standalone CoS Runner (PM2 process)
- **Clean Output Files**: The final output file contains the clean result text, while the raw JSON stream is preserved for error analysis
