# Release v0.16.x - Changelog

Released: YYYY-MM-DD

## Overview

Agent persistence, reliability, and decision transparency improvements.

## Fixes

### Agent history now persists across state resets
- **Completed agents no longer disappear** -- previously, all agent history was stored only in `state.json`; if the state file was reset or corrupted, all completed agents vanished from the UI despite metadata files existing on disk
- **Added disk-backed agent cache** -- `getAgents()` now merges in-memory state (running agents) with persisted metadata files from `data/cos/agents/{id}/metadata.json`, so completed agents always survive state resets
- **Lazy-loaded cache** with ~1987 historical agents loaded on first access and kept in sync as agents complete
- **`getAgent()` falls back to disk** -- individual agent lookups now check the cache when not found in state
- **`deleteAgent()` now cleans up disk files** -- previously only removed from state, leaving orphaned metadata directories; now removes the agent directory entirely
- **`clearCompletedAgents()` now cleans up disk files** -- previously only cleared state, leaving metadata files that would reappear on next cache load; now removes all completed agent directories

### Agent cache load made resilient to individual file errors
- **JSON parse errors no longer crash the entire cache load** -- a single corrupt `metadata.json` file previously caused `Promise.all` to reject, leaving the cache permanently empty (showing only agents from `state.json`). Now uses `Promise.allSettled` and per-file try/catch so bad files are skipped while all others load
- **Failed cache loads can now be retried** -- the cache Map is built locally and only promoted to the module-level variable after successful loading; if `readdir` or another system call fails, the cache stays `null` and the next API call will re-attempt the load
- **Diagnostic logging** -- cache load now reports count of skipped/unreadable files alongside recovered count

### Full agent recovery from disk
- **38 agents with missing metadata recovered** -- agent directories created before metadata persistence was added now get reconstructed `metadata.json` files on first cache load, using directory timestamps as completion dates
- **8 agents with legacy metadata format normalized** -- older metadata files using `agentId` instead of `id` and missing `status` field are now properly loaded into the cache
- **Zombie-cleaned agents now persist to disk** -- `cleanupZombieAgents()` previously only updated in-memory state; now writes `metadata.json` and updates the cache so zombie-cleaned agents survive state resets

### "Done" metric now reflects actual completed agent count
- **Stats counter drifted from reality** -- `state.stats.tasksCompleted` is an in-memory counter that resets when the state file is reset or corrupted; the "Done" stat on the CoS dashboard showed only completions since the last state reset (e.g., 6) instead of the actual count (e.g., 1991)
- **Now derived from disk** -- `getStatus()` counts unique completed agents from the disk-backed cache plus in-memory state, using `Math.max` with the counter to never undercount

### Completed agents now fully visible in UI
- **Replaced hard limit of 15 with paginated "Show More"** -- previously the Agents tab showed only the 15 most recent completed agents with a static "+ N more" message and no way to see the rest; now shows 50 at a time with a "Show more (N remaining)" button to load the next batch
- **Search results also paginated** -- filtered results use the same incremental loading, and visible count resets when the search query changes
- **Fixed missing `socket.off('cos:agent:updated')` cleanup** -- the WebSocket event listener was never unregistered on component unmount

## Improvements

### CoS now records every no-action decision with reasons
- **Capacity decisions logged** -- when max concurrent agents (global or per-project) prevents task spawning, the reason is recorded to the decision log with full context (which limit was hit, how many agents running)
- **Cooldown decisions logged** -- when a system task is skipped because its target app is still in cooldown, the decision log captures the app ID and cooldown window duration
- **Idle decisions logged** -- when CoS has nothing to spawn after a full evaluation, it records whether that's due to tasks awaiting approval, all tasks on cooldown, or genuinely no work available
- **New decision types** -- added `CAPACITY_FULL` and `IDLE` to the decision type vocabulary; started using the previously-defined but unused `COOLDOWN_ACTIVE` type
- **Dashboard surfacing** -- capacity and cooldown decisions now appear in the impactful decisions summary on the dashboard, making it easy to spot bottlenecks at a glance

### Learning system error categorization improved
- **Broadened usage-limit pattern** -- session limits like "You've hit your limit Â· resets 6am" were falling through as "unknown" because the pattern only matched "hit your usage limit" (with "usage"); now catches "hit your limit", "plan limit", "daily limit", and "session limit" variants
- **Added startup-failure detection** -- agents that exit immediately with <50 chars of output now get categorized as `startup-failure` instead of `unknown`, distinguishing instant provider failures from real task errors
- **Added turn-limit and billing-error patterns** -- new error categories for agents hitting turn budget limits and provider billing/subscription issues
- **Wait time extraction improved** -- now parses "resets Xam/pm" format in addition to "try again in..." for usage limit cooldown times

### Fixed byModelTier data corruption in task type reset
- **Model tier metrics drifted from reality** -- `resetTaskTypeLearning()` subtracted counts from `byTaskType`, `errorPatterns`, `routingAccuracy`, and `totals`, but never touched `byModelTier`; after rehabilitation resets, the heavy tier showed 653 completed / 3 succeeded (0.46% success) due to accumulated historical data that was cleared from other structures but not from tier metrics
- **Now subtracts routing accuracy data from byModelTier** -- when a task type is reset, its per-tier succeeded/failed counts are decremented from the corresponding `byModelTier` entries, with duration estimated proportionally from the task type's average
- **Empty tiers cleaned up** -- if a tier's completed count reaches zero after subtraction, the tier entry is removed entirely
