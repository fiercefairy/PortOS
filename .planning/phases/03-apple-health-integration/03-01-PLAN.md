---
phase: 03-apple-health-integration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - server/lib/appleHealthValidation.js
  - server/services/appleHealthIngest.js
  - server/services/appleHealthQuery.js
  - server/routes/appleHealth.js
  - server/lib/fileUtils.js
  - server/index.js
  - client/src/services/api.js
autonomous: true
requirements:
  - HLT-01
  - HLT-02

must_haves:
  truths:
    - "POST /api/apple-health/ingest accepts Health Auto Export JSON, validates with Zod, and returns success with record counts"
    - "Duplicate records (same metric name + timestamp) are silently skipped on re-ingest"
    - "Health data is persisted to day-partitioned files at data/health/YYYY-MM-DD.json"
    - "GET /api/apple-health/metrics returns aggregated metric data for a requested date range"
  artifacts:
    - path: "server/lib/appleHealthValidation.js"
      provides: "Zod schemas for Health Auto Export JSON ingest payload"
      exports: ["healthIngestSchema"]
    - path: "server/services/appleHealthIngest.js"
      provides: "JSON ingest, dedup, day-file merge logic"
      exports: ["ingestHealthData"]
    - path: "server/services/appleHealthQuery.js"
      provides: "Date-range queries for health metrics"
      exports: ["getMetrics", "getMetricSummary", "getAvailableDateRange"]
    - path: "server/routes/appleHealth.js"
      provides: "REST endpoints for ingest and query"
      exports: ["default (router)"]
  key_links:
    - from: "server/routes/appleHealth.js"
      to: "server/services/appleHealthIngest.js"
      via: "ingestHealthData(payload)"
      pattern: "ingestHealthData"
    - from: "server/routes/appleHealth.js"
      to: "server/services/appleHealthQuery.js"
      via: "getMetrics(metricName, from, to)"
      pattern: "getMetrics"
    - from: "server/index.js"
      to: "server/routes/appleHealth.js"
      via: "app.use('/api/apple-health', appleHealthRoutes)"
      pattern: "appleHealthRoutes"
---

<objective>
Build the Apple Health data ingest pipeline: Zod validation for Health Auto Export JSON, deduplication by metric+timestamp, day-partitioned file storage at `data/health/YYYY-MM-DD.json`, and query service for reading metrics by date range.

Purpose: Creates the data foundation that both XML import (Plan 03-02) and dashboard cards (Plan 03-03) depend on.
Output: Working REST API at `/api/apple-health/ingest` and `/api/apple-health/metrics`, data persisted to day-partitioned files.
</objective>

<execution_context>
@/Users/antic/.claude/get-shit-done/workflows/execute-plan.md
@/Users/antic/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-apple-health-integration/03-RESEARCH.md

@server/lib/fileUtils.js ‚Äî PATHS constants, readJSONFile, ensureDir
@server/lib/meatspaceValidation.js ‚Äî Zod schema patterns
@server/routes/backup.js ‚Äî Route pattern with asyncHandler, io access
@server/services/meatspaceAlcohol.js ‚Äî Service patterns (pure functions, file read/write)
@server/index.js ‚Äî Route registration pattern

<interfaces>
<!-- Key types and contracts the executor needs. Extracted from codebase. -->

From server/lib/fileUtils.js:
```javascript
export const PATHS = {
  root: join(__lib_dirname, '../..'),
  data: join(__lib_dirname, '../../data'),
  meatspace: join(__lib_dirname, '../../data/meatspace')
  // ... health needs to be added here
};
export async function ensureDir(dir) { ... }
export async function readJSONFile(filePath, defaultValue) { ... }
```

From server/lib/errorHandler.js:
```javascript
export function asyncHandler(fn) { ... }
export class ServerError extends Error { ... }
```

From server/lib/validation.js:
```javascript
export function validateRequest(schema, data) { ... }
```

Health Auto Export JSON schema (from research):
```json
{
  "data": {
    "metrics": [
      {
        "name": "step_count",
        "units": "count",
        "data": [{ "qty": 8432, "date": "2024-01-15 08:30:00 -0800" }]
      }
    ]
  }
}
```

Day-partitioned file schema:
```json
{
  "date": "2024-01-15",
  "metrics": {
    "step_count": [
      { "date": "2024-01-15 08:30:00 -0800", "qty": 4211, "unit": "count" }
    ]
  },
  "updated": "2024-01-16T10:00:00.000Z"
}
```
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create validation schemas, ingest service, and day-partitioned storage</name>
  <files>
    server/lib/appleHealthValidation.js
    server/services/appleHealthIngest.js
    server/lib/fileUtils.js
  </files>
  <action>
**1. Add PATHS.health to fileUtils.js:**

In `server/lib/fileUtils.js`, add to the PATHS object:
```javascript
health: join(__lib_dirname, '../../data/health'),
```
Place it alphabetically between `digitalTwin` and `memory`.

**2. Create server/lib/appleHealthValidation.js:**

Zod schemas following the meatspaceValidation.js pattern:

- `healthDataPointSchema`: Object with `date` (string, required), `qty` (number, optional), `Min`/`Avg`/`Max` (number, optional for heart rate), `totalSleep`/`deep`/`rem`/`core`/`awake` (number, optional for sleep). Use `.passthrough()` to allow future fields from app updates.

- `healthMetricSchema`: Object with `name` (string, min 1), `units` (string, optional), `data` (array of healthDataPointSchema).

- `healthIngestSchema`: Object with `data` (object containing `metrics` array of healthMetricSchema, defaulting to `[]`, and `workouts` array of `z.unknown()`, defaulting to `[]`). Use `.passthrough()` on the `data` object to allow future Health Auto Export fields.

Export all three schemas.

**3. Create server/services/appleHealthIngest.js:**

Pure functions + file I/O service:

- `extractDateStr(dateString)`: Extract YYYY-MM-DD from Apple Health timestamp string. Use `dateString.substring(0, 10)` (not Date parsing) to avoid timezone conversion issues per research pitfall 5. Validate with regex `/^\d{4}-\d{2}-\d{2}$/`. Return null for invalid dates.

- `dedupKey(metricName, dateString)`: Return `${metricName}::${dateString}` for dedup comparisons.

- `readDayFile(dateStr)`: Read `join(PATHS.health, dateStr + '.json')` using `readJSONFile` with default `{ date: dateStr, metrics: {} }`.

- `writeDayFile(dateStr, data)`: Ensure PATHS.health dir exists, set `data.updated = new Date().toISOString()`, write JSON with 2-space indent.

- `mergeIntoDay(dateStr, metricName, newPoints)`: Load existing day file, build Set of existing date strings for that metric, filter new points to only those not already present, append unique points, write day file. Return count of new unique points added.

- `ingestHealthData(payload)`: Main entry point. Iterate `payload.data.metrics`. For each metric, group its `data` points by extracted date string (skip points with null/invalid date). For each day group, call `mergeIntoDay`. Accumulate totals. Return `{ metricsProcessed, recordsIngested, recordsSkipped (dupes), daysAffected }`. Log with emoji prefix: `console.log('üçé Health ingest: ${recordsIngested} records across ${daysAffected} days')`.

**Important:** All metric types from the payload are stored (not just the core four). The decision locks "import ALL Apple Health metric types."
  </action>
  <verify>
    <automated>cd server && node -e "import('./lib/appleHealthValidation.js').then(m => { const r = m.healthIngestSchema.safeParse({ data: { metrics: [{ name: 'step_count', units: 'count', data: [{ date: '2024-01-15 08:30:00 -0800', qty: 100 }] }] } }); console.log(r.success ? 'PASS' : 'FAIL: ' + JSON.stringify(r.error.issues)); })"</automated>
  </verify>
  <done>
    - healthIngestSchema validates Health Auto Export JSON format with passthrough for future fields
    - extractDateStr correctly pulls YYYY-MM-DD from timestamp strings without timezone conversion
    - mergeIntoDay deduplicates by metric name + date string, skipping existing records
    - Day files written to data/health/YYYY-MM-DD.json with correct schema
    - PATHS.health added to fileUtils.js
  </done>
</task>

<task type="auto">
  <name>Task 2: Create query service, REST routes, and client API functions</name>
  <files>
    server/services/appleHealthQuery.js
    server/routes/appleHealth.js
    server/index.js
    client/src/services/api.js
  </files>
  <action>
**1. Create server/services/appleHealthQuery.js:**

Query functions for reading health data:

- `listDayFiles()`: Read the `PATHS.health` directory, return sorted array of date strings (from filenames without .json extension). Handle dir not existing (return `[]`).

- `getAvailableDateRange()`: Call `listDayFiles()`, return `{ from: firstDate, to: lastDate, totalDays }` or null if no files.

- `getMetrics(metricName, from, to)`: Read day files in the date range. For each day file, extract the metric's data array. Return flat array of all data points across the range, sorted by date. If `from`/`to` not provided, default to last 7 days.

- `getMetricSummary(metricName, from, to)`: Call `getMetrics`, then compute summary stats: `count`, `latest` (most recent data point), `average` (of `qty` values if present, or `Avg` for heart rate). Return `{ metricName, count, latest, average, from, to, dataPoints }`.

- `getDailyAggregates(metricName, from, to)`: Group data points by day and aggregate. For `step_count`: sum `qty` per day. For `heart_rate`: average of `Avg` values per day. For `heart_rate_variability_sdnn`: average `qty` per day. For `sleep_analysis`: take `totalSleep` directly. For all others: average `qty`. Return array of `{ date, value }` objects.

- `getCorrelationData(from, to)`: Read health metrics AND alcohol data (import `getDailyAlcohol` from `meatspaceAlcohol.js`) for the date range. Build daily records with: `{ date, hrv, alcoholGrams, steps }`. Return the merged array. Also read blood tests (import `getBloodTests` from `meatspaceHealth.js`) for activity-blood correlation. Return `{ dailyData, bloodTests }`.

**2. Create server/routes/appleHealth.js:**

Following backup.js route pattern with asyncHandler:

- `POST /ingest`: Validate body with `healthIngestSchema` using `validateRequest`. Call `ingestHealthData(validated)`. Return result object.

- `GET /metrics/:metricName`: Query params `from`, `to` (optional strings). Call `getMetricSummary(metricName, from, to)`. Return summary.

- `GET /metrics/:metricName/daily`: Query params `from`, `to`. Call `getDailyAggregates(metricName, from, to)`. Return array.

- `GET /range`: Call `getAvailableDateRange()`. Return range object.

- `GET /correlation`: Query params `from`, `to`. Call `getCorrelationData(from, to)`. Return correlation data.

Export default router.

**3. Register routes in server/index.js:**

Add import at top (alphabetical with other route imports):
```javascript
import appleHealthRoutes from './routes/appleHealth.js';
```

Add route registration (before `/api/meatspace` to avoid path conflicts):
```javascript
app.use('/api/apple-health', appleHealthRoutes);
```

**4. Add client API functions in client/src/services/api.js:**

Add a new section "// Apple Health" (alphabetical placement, near the top after "// Apps"):

```javascript
// Apple Health
export const ingestAppleHealth = (data) => request('/apple-health/ingest', {
  method: 'POST',
  body: JSON.stringify(data)
});
export const getAppleHealthMetrics = (metricName, from, to) => {
  const params = new URLSearchParams();
  if (from) params.set('from', from);
  if (to) params.set('to', to);
  return request(`/apple-health/metrics/${metricName}/daily?${params}`);
};
export const getAppleHealthSummary = (metricName, from, to) => {
  const params = new URLSearchParams();
  if (from) params.set('from', from);
  if (to) params.set('to', to);
  return request(`/apple-health/metrics/${metricName}?${params}`);
};
export const getAppleHealthRange = () => request('/apple-health/range');
export const getAppleHealthCorrelation = (from, to) => {
  const params = new URLSearchParams();
  if (from) params.set('from', from);
  if (to) params.set('to', to);
  return request(`/apple-health/correlation?${params}`);
};
```
  </action>
  <verify>
    <automated>cd server && node -e "import('./routes/appleHealth.js').then(m => console.log(m.default ? 'PASS: router exported' : 'FAIL'))" && node -e "import('./services/appleHealthQuery.js').then(m => console.log(typeof m.getMetrics === 'function' && typeof m.getDailyAggregates === 'function' ? 'PASS' : 'FAIL'))"</automated>
  </verify>
  <done>
    - GET /api/apple-health/metrics/:metricName returns metric summary for date range
    - GET /api/apple-health/metrics/:metricName/daily returns daily aggregated values
    - GET /api/apple-health/range returns available data date range
    - GET /api/apple-health/correlation returns merged HRV+alcohol+steps+blood data
    - POST /api/apple-health/ingest validates and persists Health Auto Export JSON
    - Route registered in index.js at /api/apple-health
    - Client API functions added for all endpoints
  </done>
</task>

</tasks>

<verification>
1. `cd server && node -e "import('./lib/appleHealthValidation.js').then(m => console.log('validation OK'))"` -- validation module loads
2. `cd server && node -e "import('./services/appleHealthIngest.js').then(m => console.log('ingest OK'))"` -- ingest service loads
3. `cd server && node -e "import('./services/appleHealthQuery.js').then(m => console.log('query OK'))"` -- query service loads
4. `cd server && node -e "import('./routes/appleHealth.js').then(m => console.log('routes OK'))"` -- routes load
5. `cd server && npm test` -- all existing tests pass (no regressions)
</verification>

<success_criteria>
- POST /api/apple-health/ingest accepts Health Auto Export JSON and returns record counts
- Duplicate records are silently skipped on re-ingest
- Data persists to data/health/YYYY-MM-DD.json files
- Query service returns aggregated metrics for date ranges
- All existing tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/03-apple-health-integration/03-01-SUMMARY.md`
</output>
