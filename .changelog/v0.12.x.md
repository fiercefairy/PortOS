# Release v0.12.x - Changelog

Released: YYYY-MM-DD

## Overview

This release adds branch management and automated release workflow capabilities to the DevTools Git page.

## Features

### DevTools Git — Branch Update, Comparison & Release PR Workflow
- **Update Branches button**: One-click fetch and fast-forward merge of `dev` and `main` from origin, with automatic stash/restore if the working tree is dirty
- **Branch Comparison panel**: Shows how many commits `dev` is ahead of `main`, with commit list, diff stats (+insertions/-deletions/files changed), displayed as a "Release Status" card
- **Automated Release PR**: "Create Release PR" button triggers a full CoS agent task that pushes commits, updates the changelog, creates a PR from dev to main, iterates with Copilot review feedback (up to 3 rounds), verifies CI, and merges when approved
- **Release Confirmation dialog**: Modal listing the exact steps the agent will perform, preventing accidental releases
- **Push endpoint**: New server endpoint for pushing branches to origin, used by the release workflow

**Server changes**:
- `server/services/git.js` — Added `fetchOrigin`, `updateBranches`, `getBranchComparison`, `push` functions
- `server/routes/git.js` — Added `/update-branches`, `/branch-comparison`, `/push` POST endpoints

**Client changes**:
- `client/src/services/api.js` — Added `updateBranches`, `getBranchComparison`, `pushBranch` API functions
- `client/src/pages/DevTools.jsx` — Expanded GitPage with Update button, Release Status panel, release confirmation dialog, and CoS task integration

### CoS — Productivity & Streaks Dashboard
- **New Productivity Tab**: Added a "Streaks" tab to the Chief of Staff page that tracks work patterns and productivity metrics
- **Work Streaks**: Tracks consecutive days and weeks with completed tasks, displaying current and best streaks with visual emphasis
- **Hourly & Daily Patterns**: Analyzes which hours and days of the week have the highest success rates for tasks
- **AI Insights**: Generates recommendations like "Peak Performance Hour" and "Most Productive Day" based on historical patterns
- **Milestones**: Tracks achievements like "Completed 100 tasks" or "7-day work streak"
- **Gamification**: Flame icon for active streaks, trophy icons for milestones, encouraging consistent productivity

**Server changes**:
- `server/services/productivity.js` — New service with streak calculation, pattern analysis, and milestone tracking
- `server/routes/cos.js` — Added `/productivity`, `/productivity/summary`, `/productivity/recalculate` endpoints

**Client changes**:
- `client/src/components/cos/tabs/ProductivityTab.jsx` — Full-featured productivity dashboard with collapsible sections
- `client/src/components/cos/constants.js` — Added "Streaks" tab with Flame icon
- `client/src/services/api.js` — Added `getCosProductivity`, `getCosProductivitySummary`, `recalculateCosProductivity` functions

### Media → Security Page Rename
- **Renamed** the "Media" page to "Security" to better reflect its purpose as a remote security camera and microphone
- Updated route from `/media` to `/security`
- Added descriptive subtitle explaining the page turns the PortOS host into a remote webcam and audio monitor accessible over Tailscale from a phone

### DevTools Git — Generic Git Management for All Managed Apps
- **Auto-detect branches**: Server now detects `main`/`master` and `dev`/`develop` branches per-repo instead of hardcoding `dev`/`main`
- **Changelog detection**: `getGitInfo()` returns whether a `.changelog/` directory exists, enabling conditional changelog steps in release prompts
- **Generalized Update**: `updateBranches()` auto-detects which branches to update instead of hardcoded `['dev', 'main']`
- **Generalized Release PR**: `buildReleasePrompt()` now uses the app name, detected branch names, and conditionally includes changelog management based on repo structure
- **App filtering**: Archived apps are filtered out of the Git page dropdown
- **Dynamic UI**: Branch comparison label, release button visibility, release dialog steps, and toast messages all adapt to detected branch names

### CoS — Completed Agent Timestamps
- **Completed timestamp display**: Completed agent cards now show the date and time they finished (e.g., "Feb 8 3:30 PM") next to the duration, with full timestamp on hover

### Agents — Tools Tab with AI Content Generation & Autonomous Engagement
- **Tools tab**: New tab in the Agents page for interactive Moltbook content creation and engagement
- **AI post generation**: Generate Moltbook posts in an agent's unique voice using their personality profile, topics, and style
- **AI comment generation**: Generate contextual replies to posts with awareness of existing comments and agent history
- **Feed browser**: Browse and sort the Moltbook feed, or use AI-powered relevance scoring to find posts matching an agent's topics
- **Post & Comment composer**: Preview, edit, and publish AI-generated content with one-click publishing
- **Autonomous engage**: One-click "Engage Now" button that finds relevant posts, upvotes them, and generates/posts AI comments
- **History-aware prompts**: Content generation includes recent agent activity to avoid repetitive posts and comments
- **`engage` action type**: New scheduled action type for autonomous agent engagement (browsing + voting + commenting)
- **AI-powered action executor**: Post and comment scheduled actions now auto-generate content via AI when params are empty

**Server changes**:
- `server/services/agentContentGenerator.js` — New service with `generatePost`, `generateComment`, `generateReply`, and shared prompt-building helpers
- `server/services/agentFeedFilter.js` — New service with `scorePosts`, `findRelevantPosts`, `findReplyOpportunities` for topic-based feed filtering
- `server/routes/agentTools.js` — 10 new endpoints for content generation, publishing, feed browsing, and engagement
- `server/services/agentActionExecutor.js` — Enhanced with AI content generation fallback and new `engage` compound action
- `server/lib/validation.js` — Added tool schemas and `engage` action type

**Client changes**:
- `client/src/components/agents/tabs/ToolsTab.jsx` — Full-featured tools UI with feed browser, post/comment composers, drafts panel, and engage button
- `client/src/services/api.js` — Added 11 new API functions for agent tools plus 4 for draft management
- `client/src/components/agents/constants.js` — Added Tools tab and Engage action type

### Agents — Draft Persistence for Generated Content
- **Auto-save drafts**: AI-generated posts and comments are automatically saved as drafts, so content isn't lost when navigating away
- **Drafts panel**: New section in the Tools tab listing all saved drafts per agent, sorted by newest first
- **Load into composer**: Click a draft to load it back into the post or comment composer for further editing
- **Auto-delete on publish**: Drafts are automatically removed when their content is published to Moltbook
- **Manual delete**: Remove unwanted drafts with the delete button

**Server changes**:
- `server/services/agentDrafts.js` — New service for draft CRUD operations, persisting to `data/agents/drafts/{agentId}.json`
- `server/routes/agentTools.js` — Added GET/POST/PUT/DELETE draft endpoints
- `server/lib/validation.js` — Added `createDraftSchema` and `updateDraftSchema`

### Agents — Published Content Tracking
- **Published content panel**: New section in Tools tab showing all posts and comments published by an agent
- **Live engagement metrics**: Displays current score and comment count fetched from Moltbook API
- **Direct links**: Each published item links directly to its page on Moltbook
- **Configurable timeframe**: View published content from the last 7, 14, or 30 days
- **Auto-refresh**: Published content list refreshes after publishing or engaging

**Server changes**:
- `server/routes/agentTools.js` — Added `GET /published` endpoint that aggregates activity logs across multiple days and enriches with live Moltbook data

**Client changes**:
- `client/src/services/api.js` — Added `getAgentPublished()` API function
- `client/src/components/agents/tabs/ToolsTab.jsx` — Published Content section with posts/comments tables, engagement stats, days selector, and auto-refresh on publish/engage

### Agents — Post Monitor & Engagement Response
- **Check Posts button**: One-click check of engagement on all published posts, with comment counts and scores
- **Auto-upvote**: Upvotes positive comments on the agent's posts (respects rate limits)
- **AI reply generation**: Generates and publishes contextual replies to comments using the agent's personality
- **`monitor` scheduled action**: New automation type for recurring post engagement checks
- **Engagement summary**: Results panel showing posts checked, comments found, upvotes given, and replies posted

**Server changes**:
- `server/services/agentPublished.js` — New shared service for collecting published posts from activity logs (extracted from route for DRY reuse)
- `server/routes/agentTools.js` — Added `POST /check-posts` endpoint, refactored `/published` to use shared helper
- `server/services/agentActionExecutor.js` — Added `executeMonitor` function and `monitor` case to action dispatch
- `server/lib/validation.js` — Added `monitor` to action types, added `checkPostsSchema`

**Client changes**:
- `client/src/services/api.js` — Added `checkAgentPosts()` API function
- `client/src/components/agents/tabs/ToolsTab.jsx` — Added Check Posts button, loading spinner, and engagement results panel
- `client/src/components/agents/constants.js` — Added `monitor` action type

### Agents — Agent-Centric Drill-Down Redesign
- **Agent list view**: Top-level grid of agent cards with aggregate stats, replacing the flat tab layout
- **Agent detail view**: Drill into any agent to see all its data: personality, accounts, tools, published content, schedules, and activity
- **Merged Overview tab**: Personality editing and account management unified in a single view per agent
- **Published content tab**: Promoted from a section in Tools to its own dedicated tab with engagement metrics
- **Scoped sub-tabs**: All sub-tabs (Tools, Published, Schedules, Activity) are automatically filtered to the selected agent — no more redundant agent selectors
- **Deep-linkable URLs**: Every view has a unique URL (e.g., `/agents/:id/tools`, `/agents/:id/published`)
- **Simplified sidebar**: Agents section collapsed from a 5-item expandable menu to a single link

### Dashboard — Archived App Styling
- **Greyed-out cards**: Archived apps on the main dashboard now render with reduced opacity, dimmed icon/title colors, and a subtle "Archived" badge next to the app name
- **Sorted to bottom**: Archived apps are sorted after active apps in the grid so they don't intermix with actively managed services
- **Excluded from stats**: The Quick Stats cards (Total, Online, Stopped, Not Started) now count only active apps; the header shows an "(N archived)" count when archived apps exist

### CyberCity 3D Dashboard
- **Immersive 3D city visualization**: Navigate an interactive cyberpunk cityscape where each managed app is a neon-lit building, providing a spatial overview of your entire infrastructure
- **Status-driven buildings**: Building height and neon edge color reflect app status — tall cyan for online, amber for stopped, dim indigo for not started, and muted slate in the warehouse district for archived apps
- **Live AI agent entities**: Active CoS agents appear as floating, rotating diamond wireframes above the building they're working on, with sparkle trails and state-based coloring
- **Tron-style ground grid**: Infinite cyan grid with fog depth fade creates cyberpunk atmosphere
- **Real-time HUD overlay**: Clock, connection status, CoS activity indicator, scrolling activity log from `cos:log` events, and an agent status bar at the bottom
- **Full orbit controls**: Mouse drag to rotate, scroll to zoom, right-click to pan around the city
- **Lazy-loaded**: CyberCity bundle only loads when navigating to `/city`, keeping the main bundle lean
- **Real-time updates**: Buildings update live via WebSocket when apps start/stop, agents appear/complete via CoS socket events

**Client changes**:
- `client/src/pages/CyberCity.jsx` — Page component with data hook integration and HUD overlay
- `client/src/hooks/useCityData.js` — Data hook fetching apps, agents, CoS status with socket subscriptions
- `client/src/components/city/CityScene.jsx` — React Three Fiber Canvas with orbit controls
- `client/src/components/city/CityGround.jsx` — drei Grid with Tron-style cyan lines
- `client/src/components/city/CityLights.jsx` — Ambient, point lights, and fog for atmosphere
- `client/src/components/city/Building.jsx` — App building mesh with neon wireframe edges and hover glow
- `client/src/components/city/BuildingCluster.jsx` — Positions all buildings via layout algorithm with archive district
- `client/src/components/city/AgentEntity.jsx` — Floating octahedron agent with bob animation and sparkles
- `client/src/components/city/HolographicPanel.jsx` — drei Html floating status label per building
- `client/src/components/city/CityParticles.jsx` — Ambient sparkle particles across the scene
- `client/src/components/city/CityHud.jsx` — HTML overlay with clock, status, activity log, agent bar
- `client/src/components/city/CityActivityLog.jsx` — Scrolling cos:log event feed
- `client/src/components/city/CityAgentBar.jsx` — Bottom bar showing active agent pills
- `client/src/components/city/cityLayout.js` — Pure layout function: downtown grid + warehouse district
- `client/src/components/city/cityConstants.js` — Colors, dimensions, district parameters
- `client/src/App.jsx` — Added lazy-loaded `/city` route
- `client/src/components/Layout.jsx` — Added CyberCity nav item and full-bleed layout support

## Fixes

### Managed App Port Conflict — ENV Leak & Detection
- **Fix**: When PortOS started managed apps via `startFromEcosystem()`, the PortOS server's own `PORT=5554` env var leaked into child processes. Apps with `process.env.PORT || fallback` in their ecosystem configs would bind to 5554 instead of their intended port, crashing portos-server on restart.
- **Fix**: Port detection regex in `parseEcosystemConfig()` couldn't parse `process.env.PORT || 4420` expressions — it only captured `process.env.PORT` and failed to resolve it. Now extracts the `|| fallback` value.
- **Solution**: `startFromEcosystem()` now strips `PORT` and `HOST` from the inherited env before spawning PM2, and `resolvePortValue()` handles `expr || fallback` patterns

### CoS Runner State File Corruption
- **Fix**: `loadState()` in `cos-runner/index.js` used heuristic `isValidJSON()` checks that rejected valid nested JSON (e.g., objects ending with `}}`) and missed actual corruption (extra `}` on a separate line). A concurrent `saveState()` race condition could produce partial writes, corrupting the state file.
- **Solution**: Replaced heuristic validation with direct `JSON.parse`, added atomic writes (temp file + rename) to prevent partial-write corruption, and serialized `saveState()` calls through a promise chain to eliminate race conditions

### Runner Config Access Crash
- **Fix**: `server/services/runner.js` was accessing `aiToolkitInstance.config.dataDir` and `aiToolkitInstance.config.hooks`, but the AI Toolkit object returned by `createAIToolkit()` has no `.config` property (config is internal to service closures). This caused a `TypeError: Cannot read properties of undefined (reading 'dataDir')` whenever the PortOS runner shim's `executeCliRun` was invoked.
- **Solution**: Pass `dataDir` and `hooks` explicitly to the runner shim via `setAIToolkit(toolkit, config)` and store them in a local `runnerConfig` variable

## Improvements

### CoS — Learning Health Summary on Dashboard
- **Learning stat card**: Added a 5th stat card to the CoS main page showing overall task learning success rate with visual health indicators
- **Quick access**: Clicking the Learning card navigates directly to the Learning tab for detailed analytics
- **Skipped task alerts**: Shows a warning count when task types have been auto-skipped due to poor performance (<30% success after 5+ attempts)
- **Status indicators**: Card border changes color based on health — purple for good, yellow for warning states, red for critical (skipped tasks)
- **Mobile support**: Learning summary displayed as a full-width card at the bottom of the mobile stats grid

**Server changes**:
- `server/services/taskLearning.js` — Added `getLearningSummary()` function returning lightweight health metrics (healthy/warning/critical/skipped counts, overall success rate)
- `server/routes/cos.js` — Added `/learning/summary` endpoint

**Client changes**:
- `client/src/services/api.js` — Added `getCosLearningSummary()` API function
- `client/src/pages/ChiefOfStaff.jsx` — Added learning summary state, fetches summary with page data, renders clickable Learning stat card in both desktop (5-column grid) and mobile layouts

### Agents — Moltbook Account Suspension Detection & Early Termination
- **Suspension detection**: API client now attaches HTTP status codes and a `suspended` flag to errors, with `isAccountSuspended()` helper for easy detection
- **Early loop termination**: Monitor (check-posts), engage, and scheduled executor loops all detect 403 "account suspended" responses and immediately halt — preventing wasted AI generation calls and failing API requests
- **Automatic account status update**: When suspension is detected, the account is automatically marked as `suspended` in the database, preventing further scheduled actions from running
- **Activity logging**: Suspended monitors log as `failed` with the suspension reason instead of `completed`

**Server changes**:
- `server/integrations/moltbook/api.js` — Enriched error objects with `.status` and `.suspended` properties, added `isAccountSuspended()` helper
- `server/routes/agentTools.js` — Check-posts endpoint detects suspension mid-loop, halts immediately, marks account suspended
- `server/services/agentActionExecutor.js` — Monitor and engage actions detect suspension and break early

### Agents — Moltbook Verification Challenge Auto-Solver
- **Challenge detection**: API responses with `verification_required: true` are automatically intercepted and solved
- **AI-powered solver**: Uses the active AI provider to interpret obfuscated math word problems (e.g., `"LoOoBbSsTtEeR cLlAaW FoOrRcCeE"` = "lobster claw force") and compute the answer
- **Regex fallback**: Word-to-number parser handles simpler challenges when AI is unavailable
- **Auto-submission**: Solved answers are submitted to `POST /api/v1/verify` with the verification code, all within the 5-minute challenge window
- **Probe script**: `server/scripts/moltbook-probe.mjs` polls suspended accounts and exercises all API endpoints to capture challenge formats

**Server changes**:
- `server/integrations/moltbook/challengeSolver.js` — New module with `solveChallenge()`, `cleanChallengeText()`, AI and regex solvers
- `server/integrations/moltbook/api.js` — Replaced speculative HMAC handler with `handleVerification()` that detects and auto-solves challenges
- `server/scripts/moltbook-probe.mjs` — New standalone probe script for challenge format discovery

### CoS — Quick Summary Widget
- **At-a-glance dashboard**: New compact status bar on the Tasks tab showing today's work, streak status, pending items, and next scheduled job
- **Today's progress**: Displays tasks completed/failed, active running count, and total time worked today
- **Streak visualization**: Shows current daily streak with fire icon that lights up orange when 3+ day streaks are active
- **Pending queue**: Highlights pending user tasks and system tasks awaiting approval
- **Next job countdown**: Shows the next scheduled autonomous job with time until due (e.g., "git-maintenance in 2h 15m")
- **Smart visibility**: Widget only appears when there's meaningful data to display, staying hidden during first-run or idle states

**Server changes**:
- `server/routes/cos.js` — Added `GET /quick-summary` endpoint that aggregates today's activity, streak data, job schedule, and pending approvals in a single efficient call

**Client changes**:
- `client/src/components/cos/QuickSummary.jsx` — New component with responsive layout, auto-refresh every 30 seconds
- `client/src/components/cos/index.js` — Exported QuickSummary component
- `client/src/services/api.js` — Added `getCosQuickSummary()` API function
- `client/src/pages/ChiefOfStaff.jsx` — Renders QuickSummary widget on the Tasks tab

### CoS — Markdown Preview for Agent Output
- **Rendered markdown**: Agent run output in the "Show" expanded panel is now rendered as styled markdown instead of raw text
- **Rich formatting**: Headings, tables, bold text, code blocks, lists, horizontal rules, and blockquotes are all properly styled with the PortOS dark theme
- **Tool line preservation**: Operational log lines (tool invocations, arrows, stderr) remain in monospace format for readability while content blocks render as markdown
- **New dependency**: Added `react-markdown` for reliable markdown parsing

**Client changes**:
- `client/src/components/cos/MarkdownOutput.jsx` — New reusable markdown rendering component with custom Tailwind-styled element mappings
- `client/src/components/cos/tabs/AgentCard.jsx` — Expanded output section now groups lines into tool blocks (monospace) and content blocks (markdown), rendered via `OutputBlocks` component

### CoS — Daily Briefing Page
- **Briefing tab**: New "Briefing" tab in the Chief of Staff page displaying daily briefings generated by the autonomous Daily Briefing job
- **Date selector**: Browse historical briefings via a dropdown showing all available dates
- **Structured display**: Briefing markdown is parsed into collapsible sections with contextual icons (tasks, agents, brain, system, focus areas)
- **Inline formatting**: Renders bold text, code snippets, bullet lists, and numbered lists from briefing markdown
- **Notification integration**: A notification is automatically created when a daily briefing completes, linking directly to `/cos/briefing`
- **Sidebar navigation**: Briefing link added to the CoS sidebar section for quick access

**Server changes**:
- `server/services/cos.js` — Added `listBriefings()`, `getBriefing(date)`, `getLatestBriefing()` functions; briefing notification on agent completion
- `server/services/notifications.js` — Added `BRIEFING_READY` notification type
- `server/routes/cos.js` — Added `GET /briefings`, `GET /briefings/latest`, `GET /briefings/:date` endpoints

**Client changes**:
- `client/src/components/cos/tabs/BriefingTab.jsx` — New tab component with markdown parsing, collapsible sections, and date navigation
- `client/src/components/cos/constants.js` — Added "Briefing" tab with Newspaper icon (first position)
- `client/src/components/cos/index.js` — Exported BriefingTab component
- `client/src/services/api.js` — Added `getCosBriefings()`, `getCosLatestBriefing()`, `getCosBriefing(date)` functions
- `client/src/components/Layout.jsx` — Added Briefing link to CoS sidebar navigation
- `client/src/pages/ChiefOfStaff.jsx` — Imported and rendered BriefingTab

### CoS — Actionable Insights Banner
- **Priority action surfacing**: New banner at the top of the Tasks tab that surfaces the single most important thing requiring user attention
- **Multi-source intelligence**: Aggregates insights from pending approvals, blocked tasks, health issues, learning failures, and unread notifications
- **Priority ranking**: Insights are sorted by priority (critical → high → medium → low → info), showing the most urgent item first
- **One-click actions**: Each insight has a labeled action button that navigates directly to the relevant page to address the item
- **Dismissible**: Insights can be dismissed for the session to focus on remaining items
- **Compact design**: Gradient-styled banner with priority-based coloring (red pulse for critical, orange for high priority) that doesn't overwhelm the UI
- **Remaining count**: Shows "+N more actions available" when multiple insights exist

**Server changes**:
- `server/routes/cos.js` — Added `GET /actionable-insights` endpoint that aggregates pending approvals, blocked tasks, health issues, learning failures, and notifications into prioritized actionable items

**Client changes**:
- `client/src/components/cos/ActionableInsightsBanner.jsx` — New component with priority-based styling, action buttons, dismiss functionality, and auto-refresh every 60 seconds
- `client/src/components/cos/index.js` — Exported ActionableInsightsBanner component
- `client/src/services/api.js` — Added `getCosActionableInsights()` API function
- `client/src/pages/ChiefOfStaff.jsx` — Renders ActionableInsightsBanner above QuickSummary on the Tasks tab

### Agents — Per-Agent AI Provider/Model Configuration
- **Agent-level AI config**: Each agent can now have its own default AI provider and model for content generation, instead of always using the globally active provider
- **Overview tab selector**: New "Default AI Provider" section on the agent Overview tab with provider and model dropdowns, plus a dedicated Save button
- **System Default fallback**: When no provider is configured (or cleared), the agent falls back to the globally active provider
- **Automated flows**: Scheduled actions (post, comment, engage, monitor) all use the agent's configured provider when available
- **Manual generation**: "Generate Post" and "Generate Comment" in the Tools tab use the agent's AI config
- **Challenge solver**: Moltbook verification challenges can use the agent's preferred provider for solving

**Server changes**:
- `server/lib/validation.js` — Added `agentAiConfigSchema` and `aiConfig` field to `agentSchema`
- `server/services/agentPersonalities.js` — `createAgent()` preserves `aiConfig` field
- `server/services/agentActionExecutor.js` — `executePost`, `executeComment`, `executeEngage`, `executeMonitor` pass `agent.aiConfig` to content generators
- `server/routes/agentTools.js` — `check-posts` and `engage` endpoints pass `agent.aiConfig` to `generateReply`/`generateComment`
- `server/integrations/moltbook/challengeSolver.js` — `solveChallenge()` and `solveWithAI()` accept optional AI config for agent-specific provider

**Client changes**:
- `client/src/components/agents/tabs/OverviewTab.jsx` — Added "Default AI Provider" card with provider/model selectors and save button
- `client/src/components/agents/tabs/ToolsTab.jsx` — Generate Post and Generate Comment pass agent's `aiConfig` to API calls
- `client/src/components/agents/AgentDetail.jsx` — Passes `agent` prop to ToolsTab
